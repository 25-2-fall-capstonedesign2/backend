<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AnyCall GPU Server Simulation</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background-color: #1e1e1e; color: #00ff00; max-width: 1000px; margin: 0 auto; }
        .panel { border: 1px solid #444; padding: 15px; margin-bottom: 20px; background: #2d2d2d; border-radius: 5px; }
        h1, h3 { margin-top: 0; color: #fff; }
        input { background: #333; border: 1px solid #555; color: white; padding: 5px; width: 200px; }
        button { padding: 8px 15px; background: #444; color: #fff; border: 1px solid #0f0; cursor: pointer; font-family: inherit; margin-right: 5px; }
        button:hover { background: #555; }
        #logs { height: 500px; overflow-y: scroll; border: 1px solid #444; padding: 10px; background: #000; }

        .msg-start { color: #ffff00; font-weight: bold; border-bottom: 1px dashed #ffff00; padding-bottom: 2px; }
        .msg-send { color: #00ffff; }   /* GPU -> Server */
        .msg-recv { color: #ff00ff; }   /* Server -> GPU */
        .msg-sys { color: #888; }
        .binary-data { color: #aaa; font-size: 0.9em; margin-left: 20px; display: block; }
    </style>
</head>
<body>
<h1>ğŸ–¥ï¸ GPU Server Simulator (anycall.store)</h1>

<div class="panel">
    <h3>1. Connection</h3>
    <label>Domain:</label> <input type="text" id="domain" value="anycall.store">
    <button onclick="connect()">ğŸ”Œ Connect (WSS)</button>
    <button onclick="disconnect()">âŒ Disconnect</button>
    <span id="status" style="color:red; margin-left:10px;">Disconnected</span>
</div>

<div class="panel" id="controlPanel" style="display:none; border-color: #0f0;">
    <h3>2. Session Control</h3>
    <div id="sessionInfo" style="margin-bottom: 10px; color: #fff;">ëŒ€ê¸° ì¤‘... (Start ì‹ í˜¸ ëŒ€ê¸°)</div>

    <button onclick="fetchProfileInfo()">â„¹ï¸ Get Metadata (HTTP GET)</button>
    <button onclick="downloadVoiceProfile()">ğŸ“¥ Download File (HTTP GET)</button>
    <hr style="border-color:#444;">
    <button onclick="sendMockResult()">ğŸ“¤ Send Audio Result (Binary)</button>
</div>

<div id="logs"></div>

<script>
    let ws;
    let currentVoiceId = null;
    let currentSessionId = null;

    function getWssUrl() {
        return `wss://${document.getElementById('domain').value}/ws-gpu`;
    }

    function log(msg, type = 'msg-sys') {
        const div = document.createElement('div');
        div.innerHTML = `[${new Date().toLocaleTimeString()}] <span class="${type}">${msg}</span>`;
        document.getElementById('logs').prepend(div);
    }

    // ì´ì§„ ë°ì´í„° ìƒì„¸ ë¡œê¹…
    async function logBinary(blobOrBuffer, direction) {
        let buffer;
        let size;

        if (blobOrBuffer instanceof Blob) {
            size = blobOrBuffer.size;
            buffer = await blobOrBuffer.arrayBuffer();
        } else {
            size = blobOrBuffer.byteLength;
            buffer = blobOrBuffer;
        }

        const view = new Uint8Array(buffer);
        // ì• 16ë°”ì´íŠ¸ Hex ë³€í™˜
        const preview = Array.from(view.subarray(0, 16))
            .map(b => b.toString(16).padStart(2, '0').toUpperCase())
            .join(' ');

        const arrow = direction === 'SENT' ? 'â¬†ï¸' : 'â¬‡ï¸';
        const typeClass = direction === 'SENT' ? 'msg-send' : 'msg-recv';

        log(`${arrow} [Binary] Size: ${size} bytes <span class="binary-data">Hex: ${preview} ...</span>`, typeClass);
        console.log(`[${direction}] Full Data:`, view);
    }

    function connect() {
        const url = getWssUrl();
        log(`Connecting to ${url}...`);
        ws = new WebSocket(url);

        ws.onopen = () => {
            document.getElementById('status').textContent = "Connected";
            document.getElementById('status').style.color = "#0f0";
            document.getElementById('controlPanel').style.display = "block";
            log("âœ… WebSocket Connected", 'msg-sys');
        };

        ws.onmessage = (event) => {
            // 1. í…ìŠ¤íŠ¸ ë©”ì‹œì§€ (JSON ëª…ë ¹ì–´)
            try {
                // JSON íŒŒì‹± ì‹œë„
                const msg = JSON.parse(event.data);
                if (msg.type === 'start') {
                    handleStartSignal(msg);
                } else {
                    log(`ğŸ“© [JSON] ${JSON.stringify(msg)}`, 'msg-recv');
                }
            } catch (e) {
                // 2. ë°”ì´ë„ˆë¦¬ ë©”ì‹œì§€ (ì˜¤ë””ì˜¤ ë°ì´í„°)
                // WebSocketì€ ê¸°ë³¸ì ìœ¼ë¡œ Blobìœ¼ë¡œ ì˜¬ ìˆ˜ ìˆìŒ
                if (event.data instanceof Blob || event.data instanceof ArrayBuffer) {
                    logBinary(event.data, 'RECV');
                } else {
                    log(`ğŸ“© [Unknown] ${event.data}`, 'msg-recv');
                }
            }
        };

        ws.onclose = () => {
            document.getElementById('status').textContent = "Disconnected";
            document.getElementById('status').style.color = "red";
            log("âŒ Disconnected", 'msg-sys');
        };
    }

    function disconnect() {
        if (ws) ws.close();
    }

    function handleStartSignal(msg) {
        currentVoiceId = msg.voiceProfileId;
        currentSessionId = msg.sessionId;

        log(`ğŸš€ START Signal Received!`, 'msg-start');
        log(`   SessionID: ${currentSessionId}`);
        log(`   VoiceProfileID: ${currentVoiceId}`);

        document.getElementById('sessionInfo').innerHTML =
            `Current Session: <b style="color:#ff0">${currentSessionId}</b> <br> Voice Profile ID: <b style="color:#ff0">${currentVoiceId}</b>`;
    }

    // HTTP API í˜¸ì¶œ (HTTPS ì‚¬ìš©)
    async function fetchProfileInfo() {
        if (!currentVoiceId) return alert("Start ì‹ í˜¸ë¥¼ ë¨¼ì € ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.");
        const domain = document.getElementById('domain').value;
        const url = `https://${domain}/api/voice-profiles/${currentVoiceId}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            log(`â„¹ï¸ Metadata: ${JSON.stringify(data)}`, 'msg-sys');
        } catch (e) {
            log(`Error: ${e}`, 'msg-sys');
        }
    }

    function downloadVoiceProfile() {
        if (!currentVoiceId) return alert("Start ì‹ í˜¸ë¥¼ ë¨¼ì € ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.");
        const domain = document.getElementById('domain').value;
        const url = `https://${domain}/api/voice-profiles/${currentVoiceId}/download`;

        log(`ğŸ“¥ Opening Download: ${url}`, 'msg-sys');
        window.open(url, '_blank');
    }

    function sendMockResult() {
        if (!ws || ws.readyState !== WebSocket.OPEN) return alert("Not connected");

        // ë”ë¯¸ ì˜¤ë””ì˜¤ ê²°ê³¼ ìƒì„± (ì˜ˆ: 2KB)
        const buffer = new Uint8Array(2048);
        for(let i=0; i<buffer.length; i++) buffer[i] = i % 255; // íŒ¨í„´ ë°ì´í„°

        ws.send(buffer);
        logBinary(buffer, 'SENT');
    }
</script>
</body>
</html>