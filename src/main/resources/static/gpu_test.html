<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - GPU WORKER</title>
    <meta charset="UTF-8">
</head>
<body>
<h2>GPU ì›Œì»¤ WebSocket í…ŒìŠ¤íŠ¸ (/ws-gpu)</h2>
<div>
    <button onclick="connect()">â‘  ì—°ê²° (ëŒ€ê¸° í’€ ì§„ì…)</button>
    <button onclick="disconnect()">â‘¡ ì—°ê²° ì¢…ë£Œ</button>
</div>
<hr>
<div>
    <h3>ì „ì†¡í•  í…ìŠ¤íŠ¸ ë‚´ìš©:</h3>
    <input type="text" id="textContent" value="ì•ˆë…•í•˜ì„¸ìš”, AIì…ë‹ˆë‹¤." style="width: 300px;">
</div>
<div>
    <button onclick="sendAudioChunk()">â‘¢ (0x01) AI ìŒì„± ì „ì†¡ (ê³ ê° ì „ë‹¬ìš©)</button>
    <button onclick="sendUserTranscript()">â‘£ (0x02) ì‚¬ìš©ì í…ìŠ¤íŠ¸ ì „ì†¡ (DBì €ì¥ìš©)</button>
    <button onclick="sendAiTranscript()">â‘¤ (0x03) AI í…ìŠ¤íŠ¸ ì „ì†¡ (DBì €ì¥ìš©)</button>
</div>
<div>
    <h3>ë¡œê·¸:</h3>
    <pre id="log"></pre>
</div>

<script>
    let socket = null;
    const textEncoder = new TextEncoder(); // í…ìŠ¤íŠ¸ë¥¼ UTF-8 ë°”ì´íŠ¸ë¡œ ë³€í™˜

    function log(message) {
        document.getElementById('log').textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
    }

    function connect() {
        if (socket) return;
        // (ì°¸ê³ ) /ws-gpu ì—”ë“œí¬ì¸íŠ¸ëŠ” GpuWebSocketHandlerê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const url = `ws://${window.location.host}/ws-gpu`;
        socket = new WebSocket(url);
        socket.binaryType = 'arraybuffer'; // ìˆ˜ì‹  íƒ€ì…ì„ ArrayBufferë¡œ
        log(`ğŸ”Œ ì—°ê²° ì‹œë„: ${url}`);

        socket.onopen = (event) => log('âœ… WebSocket ì—°ê²° ì„±ê³µ (GPU ì›Œì»¤)');

        socket.onmessage = (event) => {
            // CallServiceê°€ ê³ ê°ì˜ 'ìˆœìˆ˜ ìŒì„±' ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
            if (event.data instanceof ArrayBuffer) {
                const view = new Uint8Array(event.data);
                log(`ğŸ“¨ (ê³ ê°->GPU) 'ìˆœìˆ˜ ìŒì„±' ìˆ˜ì‹ : ${view.length} bytes (í—¤ë” ì—†ìŒ)`);
                log(`   ã„´ ë°ì´í„° ìƒ˜í”Œ: [${Array.from(view.slice(0, 10)).join(', ')}]`);
            }
        };

        socket.onerror = (error) => log('âŒ ì—ëŸ¬ ë°œìƒ: ' + JSON.stringify(error));
        socket.onclose = (event) => {
            log(`ğŸ”Œ ì—°ê²° ì¢…ë£Œ: ${event.code} - ${event.reason}`);
            socket = null;
        };
    }

    function disconnect() {
        if (socket) {
            socket.close(1000, "Worker disconnected");
            socket = null;
        }
    }

    // 1ë°”ì´íŠ¸ í—¤ë”ì™€ ë°ì´í„° ë³¸ë¬¸ì„ í•©ì¹˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function createMessage(headerByte, dataBytes) {
        const header = new Uint8Array([headerByte]);
        const combined = new Uint8Array(header.length + dataBytes.length);
        combined.set(header, 0);
        combined.set(dataBytes, header.length);
        return combined;
    }

    // â‘¢ (0x01) AI ìŒì„± ì „ì†¡
    function sendAudioChunk() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log('âš ï¸ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”');
            return;
        }
        // 1023ë°”ì´íŠ¸ ëœë¤ ì˜¤ë””ì˜¤ ë°ì´í„° ìƒì„±
        const audioData = new Uint8Array(1023);
        for (let i = 0; i < audioData.length; i++) audioData[i] = Math.floor(Math.random() * 256);

        const message = createMessage(0x01, audioData);
        socket.send(message.buffer);
        log(`ğŸ“¤ (GPU->ì„œë²„) 0x01: AI ìŒì„± ë°ì´í„° ì „ì†¡ (${message.length} bytes)`);
    }

    // â‘£ (0x02) ì‚¬ìš©ì í…ìŠ¤íŠ¸ ì „ì†¡
    function sendUserTranscript() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log('âš ï¸ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”');
            return;
        }
        const text = document.getElementById('textContent').value + " (USER)";
        const textData = textEncoder.encode(text); // í…ìŠ¤íŠ¸ë¥¼ UTF-8 ë°”ì´íŠ¸ë¡œ

        const message = createMessage(0x02, textData);
        socket.send(message.buffer);
        log(`ğŸ“¤ (GPU->ì„œë²„) 0x02: ì‚¬ìš©ì í…ìŠ¤íŠ¸ ì „ì†¡: "${text}"`);
    }

    // â‘¤ (0x03) AI í…ìŠ¤íŠ¸ ì „ì†¡
    function sendAiTranscript() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log('âš ï¸ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”');
            return;
        }
        const text = document.getElementById('textContent').value + " (AI)";
        const textData = textEncoder.encode(text); // í…ìŠ¤íŠ¸ë¥¼ UTF-8 ë°”ì´íŠ¸ë¡œ

        const message = createMessage(0x03, textData);
        socket.send(message.buffer);
        log(`ğŸ“¤ (GPU->ì„œë²„) 0x03: AI í…ìŠ¤íŠ¸ ì „ì†¡: "${text}"`);
    }
</script>
</body>
</html>