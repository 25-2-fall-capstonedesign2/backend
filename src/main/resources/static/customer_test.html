<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - CUSTOMER (API ì—°ë™)</title>
    <meta charset="UTF-8">
</head>
<body>
<h2>ê³ ê°(Client) WebSocket í…ŒìŠ¤íŠ¸ (API ì—°ë™)</h2>

<div>
    <label for="jwtToken">JWT í† í°:</label>
    <input type="text" id="jwtToken" value="ì—¬ê¸°ì—_ë¡œê·¸ì¸_í›„_ë°›ì€_JWT_í† í°ì„_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" style="width: 400px;">
</div>
<div>
    <label for="participantName">í†µí™” ëŒ€ìƒ:</label>
    <input type="text" id="participantName" value="AI-John" style="width: 150px;">
</div>
<hr>
<div>
    <button onclick="startCall()">â‘  í†µí™” ì‹œì‘ (API + WS)</button>
    <button onclick="hangupCall()">â‘¡ í†µí™” ì¢…ë£Œ (API + WS)</button>
    <button onclick="sendAudioData()">â‘¢ 'ìˆœìˆ˜ ìŒì„±' ë°ì´í„° ì „ì†¡ (í—¤ë” ì—†ìŒ)</button>
</div>
<div>
    <h3>ë¡œê·¸:</h3>
    <pre id="log"></pre>
</div>

<script>
    let socket = null;
    let currentSessionId = null;
    let currentToken = null;

    function log(message) {
        document.getElementById('log').textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
    }

    // 1. 'í†µí™” ì‹œì‘' - participantNameì„ JSONìœ¼ë¡œ ì „ì†¡
    async function startCall() {
        if (socket) {
            log('âš ï¸ ì´ë¯¸ í†µí™”ê°€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        currentToken = document.getElementById('jwtToken').value;
        const participantName = document.getElementById('participantName').value;

        if (!currentToken || currentToken.includes("ë¶™ì—¬ë„£ìœ¼ì„¸ìš”")) {
            log('âŒ JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }
        if (!participantName) {
            log('âŒ í†µí™” ëŒ€ìƒì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            log('ğŸ“ [API] /api/calls/start í˜¸ì¶œ ì‹œë„...');
            log(`   ã„´ Body: {"participantName": "${participantName}"}`);

            // 1-1. REST API í˜¸ì¶œ (JSON Body ì¶”ê°€)
            const response = await fetch('/api/calls/start', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json' // JSON ì „ì†¡ ëª…ì‹œ
                },
                body: JSON.stringify({ // ìš°ë¦¬ê°€ ìˆ˜ì •í•œ DTOì— ë§ê²Œ JSON ì „ì†¡
                    participantName: participantName
                })
            });

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            const data = await response.json();
            currentSessionId = data.callSessionId;

            log(`âœ… [API] ì„¸ì…˜ ID ë°œê¸‰ ì„±ê³µ: ${currentSessionId}`);

            // 1-2. ë°œê¸‰ë°›ì€ IDë¡œ WebSocket ì—°ê²°
            connectToWebSocket(currentSessionId);

        } catch (error) {
            log(`âŒ [API] í†µí™” ì‹œì‘ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // 2. WebSocket ì—°ê²° ë¡œì§
    function connectToWebSocket(sessionId) {
        // (ì°¸ê³ ) /ws-client ì—”ë“œí¬ì¸íŠ¸ëŠ” ClientWebSocketHandlerê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const url = `ws://${window.location.host}/ws-client?sessionId=${sessionId}`;
        socket = new WebSocket(url);
        socket.binaryType = 'arraybuffer'; // ìˆ˜ì‹  íƒ€ì…ì„ ArrayBufferë¡œ
        log(`ğŸ”Œ [WS] ì—°ê²° ì‹œë„: ${url}`);

        socket.onopen = (event) => log('âœ… [WS] WebSocket ì—°ê²° ì„±ê³µ (ê³ ê°)');

        socket.onmessage = (event) => {
            // ì„œë²„(GpuWebSocketHandler)ê°€ 0x01(ì˜¤ë””ì˜¤)ë§Œ í•„í„°ë§í•´ì„œ ë³´ëƒ…ë‹ˆë‹¤.
            if (event.data instanceof ArrayBuffer) {
                const view = new Uint8Array(event.data);
                log(`ğŸ“¨ [WS] (GPU->ê³ ê°) 'AI ìŒì„±' ìˆ˜ì‹  (0x01 íƒ€ì… ì¶”ì •): ${view.length} bytes`);
                log(`   ã„´ ë°ì´í„° ìƒ˜í”Œ: [${Array.from(view.slice(0, 10)).join(', ')}]`);
            } else {
                log(`ğŸ“¨ [WS] (ì„œë²„->ê³ ê°) í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹ : ${event.data}`);
            }
        };

        socket.onerror = (error) => log('âŒ [WS] ì—ëŸ¬ ë°œìƒ: ' + JSON.stringify(error));
        socket.onclose = (event) => {
            log(`ğŸ”Œ [WS] ì—°ê²° ì¢…ë£Œ: ${event.code} - ${event.reason}`);
            socket = null;
            currentSessionId = null;
        };
    }

    // 3. 'í†µí™” ì¢…ë£Œ'
    async function hangupCall() {
        if (!socket || !currentSessionId) {
            log('âš ï¸ ì—°ê²°ëœ í†µí™”ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        try {
            log(`ğŸ“ [API] /api/calls/${currentSessionId}/hangup í˜¸ì¶œ ì‹œë„...`);
            const response = await fetch(`/api/calls/${currentSessionId}/hangup`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${currentToken}` }
            });
            if (!response.ok) throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            log('âœ… [API] í†µí™” ì¢…ë£Œ ìš”ì²­ ì„±ê³µ');
        } catch (error) {
            log(`âŒ [API] í†µí™” ì¢…ë£Œ ì‹¤íŒ¨: ${error.message}`);
        } finally {
            if (socket) socket.close(1000, "User ended call");
            socket = null;
            currentSessionId = null;
        }
    }

    // 4. 'ìˆœìˆ˜ ìŒì„±' ë°ì´í„° ì „ì†¡
    function sendAudioData() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log('âš ï¸ ë¨¼ì € í†µí™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”');
            return;
        }
        // í”„ë¡œí† ì½œ ì•½ì†: ê³ ê°ì€ í—¤ë” ì—†ëŠ” 'ìˆœìˆ˜ ìŒì„±' ë°ì´í„°ë§Œ ë³´ëƒ…ë‹ˆë‹¤.
        const data = new Uint8Array(1024);
        for (let i = 0; i < data.length; i++) data[i] = i % 256;

        socket.send(data.buffer);
        log(`ğŸ“¤ [WS] (ê³ ê°->GPU) 'ìˆœìˆ˜ ìŒì„±' ë°ì´í„° ì „ì†¡: ${data.length} bytes (í—¤ë” ì—†ìŒ)`);
    }
</script>
</body>
</html>