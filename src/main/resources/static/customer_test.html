<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AnyCall Customer Test (Token Only)</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { margin-bottom: 10px; width: 100%; padding: 8px; box-sizing: border-box; }
        button { cursor: pointer; background-color: #007bff; color: white; border: none; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; }
        button.danger { background-color: #dc3545; }
        #logs { background: #f0f0f0; height: 300px; overflow-y: scroll; padding: 10px; border: 1px solid #ccc; font-family: monospace; font-size: 12px; }
        .log-sent { color: blue; }
        .log-recv { color: green; }
        .log-err { color: red; font-weight: bold; }
        .binary-preview { font-size: 11px; color: #666; margin-left: 10px; }
    </style>
</head>
<body>
<h2>ğŸ“± AnyCall Customer Test (Token Auth)</h2>

<div class="section">
    <h3>1. ì¸ì¦ ì„¤ì • (User ID ë¶ˆí•„ìš”)</h3>
    <label>Target Domain:</label>
    <input type="text" id="serverDomain" value="anycall.store">
    <label>JWT Token (Bearer ì œì™¸):</label>
    <input type="text" id="jwtToken" placeholder="ë¡œê·¸ì¸ í›„ ë°›ì€ í† í° ì…ë ¥">
</div>

<div class="section">
    <h3>2. í†µí™” ì¤€ë¹„</h3>
    <button onclick="loadMyVoiceProfiles()">ë‚´ ëª©ì†Œë¦¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (GET /api/voice-profiles/me)</button>
    <select id="voiceProfileSelect"><option value="">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”</option></select>
</div>

<div class="section">
    <h3>3. í†µí™” ì œì–´</h3>
    <div style="display: flex; gap: 10px;">
        <button id="btnStartCall" onclick="startCall()">ğŸ“ í†µí™” ì‹œì‘</button>
        <button id="btnHangup" class="danger" onclick="hangupCall()" disabled>âŒ í†µí™” ì¢…ë£Œ</button>
    </div>
    <p>Status: <span id="status" style="font-weight:bold;">ëŒ€ê¸° ì¤‘</span></p>
</div>

<div class="section">
    <h3>4. ì˜¤ë””ì˜¤ ì‹œë®¬ë ˆì´ì…˜</h3>
    <button id="btnMic" onclick="toggleMic()" disabled>ğŸ™ï¸ ë§ˆì´í¬ ì¼œê¸° (Dummy Data)</button>
    <div id="audioStatus">ë§ˆì´í¬ êº¼ì§</div>
</div>

<div class="section">
    <h3>Logs</h3>
    <div id="logs"></div>
</div>

<script>
    let websocket = null;
    let currentSessionId = null;
    let isMicOn = false;
    let micInterval = null;

    const logDiv = document.getElementById('logs');
    const statusSpan = document.getElementById('status');

    function getBaseUrl() { return `https://${document.getElementById('serverDomain').value}`; }
    function getWsUrl() { return `wss://${document.getElementById('serverDomain').value}`; }

    function log(msg, type = '') {
        const p = document.createElement('div');
        p.innerHTML = `[${new Date().toLocaleTimeString()}] <span class="${type}">${msg}</span>`;
        logDiv.prepend(p);
    }

    function logBinary(data, direction) {
        let byteLength = data instanceof ArrayBuffer ? data.byteLength : data.length;
        let view = data instanceof ArrayBuffer ? new Uint8Array(data) : data;
        let preview = "";

        if (view) {
            const subarray = view.subarray(0, Math.min(view.length, 16));
            preview = Array.from(subarray).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        }
        const cls = direction === 'SENT' ? 'log-sent' : 'log-recv';
        log(`${direction === 'SENT' ? 'â¬†ï¸' : 'â¬‡ï¸'} [Binary] Size: ${byteLength}B <span class="binary-preview">${preview}...</span>`, cls);
    }

    // [í•µì‹¬ ìˆ˜ì •] ë‚´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadMyVoiceProfiles() {
        const token = document.getElementById('jwtToken').value;
        if (!token) return alert("JWT Tokenì„ ì…ë ¥í•˜ì„¸ìš”.");

        try {
            // userId ì—†ì´ /me ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            // í—¤ë”ì— Authorization ì¶”ê°€ í•„ìˆ˜!
            const response = await fetch(`${getBaseUrl()}/api/voice-profiles/me`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) throw new Error(`Load Failed (${response.status})`);
            const profiles = await response.json();

            const select = document.getElementById('voiceProfileSelect');
            select.innerHTML = '';
            profiles.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.profileName} (ID: ${p.id})`;
                select.appendChild(opt);
            });
            log(`ë‚´ ëª©ì†Œë¦¬ ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${profiles.length}ê°œ`);
        } catch (e) {
            log(`ëª©ë¡ ë¡œë“œ ì—ëŸ¬: ${e.message}`, 'log-err');
        }
    }

    async function startCall() {
        const token = document.getElementById('jwtToken').value;
        const profileId = document.getElementById('voiceProfileSelect').value;
        if (!token) return alert("JWT Token í•„ìš”");
        if (!profileId) return alert("í”„ë¡œí•„ ì„ íƒ í•„ìš”");

        try {
            log("í†µí™” ì‹œì‘ ìš”ì²­...");
            const response = await fetch(`${getBaseUrl()}/api/calls/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ voiceProfileId: Number(profileId) })
            });

            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            currentSessionId = data.callSessionId;

            connectWebSocket(currentSessionId);
        } catch (e) {
            log(`ì‹œì‘ ì‹¤íŒ¨: ${e.message}`, 'log-err');
        }
    }

    function connectWebSocket(sessionId) {
        const wsUrl = `${getWsUrl()}/ws-client?sessionId=${sessionId}`;
        log(`WS ì—°ê²° ì‹œë„...`);

        websocket = new WebSocket(wsUrl);
        websocket.binaryType = 'arraybuffer';

        websocket.onopen = () => {
            log("âœ… WebSocket Connected", 'log-recv');
            statusSpan.textContent = "ì—°ê²°ë¨";
            statusSpan.style.color = "green";
            document.getElementById('btnStartCall').disabled = true;
            document.getElementById('btnHangup').disabled = false;
            document.getElementById('btnMic').disabled = false;
        };

        websocket.onmessage = (event) => {
            if (event.data instanceof ArrayBuffer) {
                logBinary(event.data, 'RECV');
            } else {
                log(`[Msg] ${event.data}`, 'log-recv');
            }
        };

        websocket.onclose = (e) => {
            log(`âŒ WebSocket Closed (${e.code})`, 'log-err');
            resetUI();
        };
    }

    async function hangupCall() {
        if (!currentSessionId) return;
        const token = document.getElementById('jwtToken').value;
        try {
            await fetch(`${getBaseUrl()}/api/calls/${currentSessionId}/hangup`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            log("ì¢…ë£Œ ìš”ì²­ ì „ì†¡ ì™„ë£Œ");
        } catch(e) {
            log("ì¢…ë£Œ ìš”ì²­ ì‹¤íŒ¨", 'log-err');
        }
        if (websocket) websocket.close();
    }

    function resetUI() {
        statusSpan.textContent = "ì¢…ë£Œë¨";
        statusSpan.style.color = "black";
        document.getElementById('btnStartCall').disabled = false;
        document.getElementById('btnHangup').disabled = true;
        document.getElementById('btnMic').disabled = true;
        stopMic();
    }

    function toggleMic() {
        if (isMicOn) stopMic(); else startMic();
    }

    function startMic() {
        isMicOn = true;
        document.getElementById('btnMic').textContent = "â¹ï¸ ë§ˆì´í¬ ë„ê¸°";
        document.getElementById('audioStatus').textContent = "ì „ì†¡ ì¤‘...";

        micInterval = setInterval(() => {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                const buffer = new Uint8Array(1024);
                for(let i=0; i<10; i++) buffer[i] = Math.floor(Math.random() * 255);
                websocket.send(buffer);
                logBinary(buffer, 'SENT');
            }
        }, 1000);
    }

    function stopMic() {
        isMicOn = false;
        document.getElementById('btnMic').textContent = "ğŸ™ï¸ ë§ˆì´í¬ ì¼œê¸°";
        document.getElementById('audioStatus').textContent = "ë§ˆì´í¬ êº¼ì§";
        if (micInterval) clearInterval(micInterval);
    }
</script>
</body>
</html>