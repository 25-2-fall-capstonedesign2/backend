<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test - CUSTOMER (API ì—°ë™)</title>
    <meta charset="UTF-8">
</head>
<body>
<h2>ê³ ê°(Client) WebSocket í…ŒìŠ¤íŠ¸ (API ì—°ë™)</h2>

<div>
    <label for="jwtToken">JWT í† í°:</label>
    <input type="text" id="jwtToken" value="ì—¬ê¸°ì—_ë¡œê·¸ì¸_í›„_ë°›ì€_JWT_í† í°ì„_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" style="width: 400px;">
</div>
<hr>
<div>
    <button onclick="startCall()">â‘  í†µí™” ì‹œì‘ (API í˜¸ì¶œ + WS ì—°ê²°)</button>
    <button onclick="hangupCall()">â‘¡ í†µí™” ì¢…ë£Œ (API í˜¸ì¶œ + WS ì¢…ë£Œ)</button>
    <button onclick="sendTestData()">â‘¢ ìŒì„± ë°ì´í„° ì „ì†¡</button>
</div>
<div>
    <h3>ë¡œê·¸:</h3>
    <pre id="log"></pre>
</div>

<script>
    let socket = null;
    let currentSessionId = null;
    let currentToken = null;

    function log(message) {
        const logEl = document.getElementById('log');
        logEl.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
    }

    // 1. (ì‹ ê·œ) 'í†µí™” ì‹œì‘' ë²„íŠ¼ í´ë¦­ ì‹œ
    async function startCall() {
        if (socket) {
            log('âš ï¸ ì´ë¯¸ í†µí™”ê°€ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return;
        }

        currentToken = document.getElementById('jwtToken').value;
        if (!currentToken || currentToken === "ì—¬ê¸°ì—_ë¡œê·¸ì¸_í›„_ë°›ì€_JWT_í† í°ì„_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”") {
            log('âŒ JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            log('ğŸ“ [API] /api/calls/start í˜¸ì¶œ ì‹œë„...');

            // 1-1. REST APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì„¸ì…˜ IDë¥¼ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
            const response = await fetch('/api/calls/start', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            const data = await response.json();
            currentSessionId = data.callSessionId;

            log(`âœ… [API] ì„¸ì…˜ ID ë°œê¸‰ ì„±ê³µ: ${currentSessionId}`);

            // 1-2. ë°œê¸‰ë°›ì€ IDë¡œ WebSocket ì—°ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤.
            connectToWebSocket(currentSessionId);

        } catch (error) {
            log(`âŒ [API] í†µí™” ì‹œì‘ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // 2. (ìˆ˜ì •) WebSocket ì—°ê²° ë¡œì§ (startCall ë‚´ë¶€ì—ì„œ í˜¸ì¶œë¨)
    function connectToWebSocket(sessionId) {
        const url = `ws://${window.location.host}/ws-client?sessionId=${sessionId}`;
        socket = new WebSocket(url);
        log(`ğŸ”Œ [WS] ì—°ê²° ì‹œë„: ${url}`);

        socket.onopen = function(event) {
            log('âœ… [WS] WebSocket ì—°ê²° ì„±ê³µ (ê³ ê°)');
        };

        socket.onmessage = function(event) {
            if (event.data instanceof Blob) {
                event.data.arrayBuffer().then(buffer => {
                    const view = new Uint8Array(buffer);
                    log('ğŸ“¨ [WS] (GPU->ê³ ê°) ë°”ì´ë„ˆë¦¬ ë©”ì‹œì§€ ìˆ˜ì‹ : ' + view.length + ' bytes');
                    log('   ë°ì´í„° ìƒ˜í”Œ: [' + Array.from(view.slice(0, 10)).join(', ') + '...]');
                });
            } else {
                log(`ğŸ“¨ [WS] (ì„œë²„->ê³ ê°) í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹ : ${event.data}`);
            }
        };

        socket.onerror = function(error) {
            log('âŒ [WS] ì—ëŸ¬ ë°œìƒ: ' + error);
        };

        socket.onclose = function(event) {
            log(`ğŸ”Œ [WS] ì—°ê²° ì¢…ë£Œ: ${event.code} - ${event.reason}`);
            socket = null;
            currentSessionId = null;
        };
    }

    // 3. (ì‹ ê·œ) 'í†µí™” ì¢…ë£Œ' ë²„íŠ¼ í´ë¦­ ì‹œ
    async function hangupCall() {
        if (!socket || !currentSessionId) {
            log('âš ï¸ ì—°ê²°ëœ í†µí™”ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            log(`ğŸ“ [API] /api/calls/${currentSessionId}/hangup í˜¸ì¶œ ì‹œë„...`);

            // 3-1. REST APIë¡œ í†µí™” ì¢…ë£Œë¥¼ ì„œë²„ì— ì•Œë¦½ë‹ˆë‹¤.
            const response = await fetch(`/api/calls/${currentSessionId}/hangup`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            if (!response.ok) {
                throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
            }

            log('âœ… [API] í†µí™” ì¢…ë£Œ ìš”ì²­ ì„±ê³µ');

        } catch (error) {
            log(`âŒ [API] í†µí™” ì¢…ë£Œ ì‹¤íŒ¨: ${error.message}`);
        } finally {
            // 3-2. API ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë¡œì»¬ WebSocket ì—°ê²°ì„ ë‹«ìŠµë‹ˆë‹¤.
            if (socket) {
                socket.close(1000, "User ended call"); // 1000 = Normal Closure
            }
            socket = null;
            currentSessionId = null;
        }
    }

    // 4. (ë™ì¼) ìŒì„± ë°ì´í„° ì „ì†¡ ë¡œì§
    function sendTestData() {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log('âš ï¸ ë¨¼ì € í†µí™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”');
            return;
        }

        const data = new Uint8Array(1024);
        data[0] = 67; // 'C' (Client)
        for (let i = 1; i < data.length; i++) {
            data[i] = Math.floor(Math.random() * 256);
        }

        socket.send(data.buffer);
        log('ğŸ“¤ [WS] (ê³ ê°->GPU) ìŒì„± ë°ì´í„° ì „ì†¡: ' + data.length + ' bytes');
    }
</script>
</body>
</html>