# =================================================================
# GitHub Actions CI/CD Workflow for Anycall Backend
# =================================================================

# 워크플로우의 이름을 지정합니다.
name: Anycall Backend CI/CD

# 워크플로우가 언제 실행될지를 정의합니다.
on:
  # 'main' 또는 'develop' 브랜치로 push 이벤트가 발생했을 때
  push:
    branches: [ "main", "develop" ]
  # 'main' 브랜치로 pull request가 생성되었을 때 (CI만 실행)
  pull_request:
    branches: [ "main" ]
# -----------------------------------------------
# (추가) Docker Hub 이미지 이름을 위한 환경 변수
# -----------------------------------------------
env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/anycall-backend

jobs:
  # ===============================================
  # 1. CI (Build & Test) Job
  # ===============================================
  build:
    # 이 작업이 실행될 가상 환경을 지정합니다.
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. JDK 21 설치
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. Gradle로 프로젝트 빌드 및 테스트
      # (build 작업은 test 작업을 자동으로 포함합니다)
      - name: Build with Gradle
        run: ./gradlew build

      # 5. (신규) Docker Hub 로그인
      # GitHub Secrets에 DOCKER_USERNAME, DOCKER_PASSWORD 등록 필요
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. (신규) Docker 이미지 빌드 및 푸시
      # Dockerfile을 이용해 이미지를 빌드하고 Docker Hub에 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # Dockerfile이 있는 위치
          file: ./Dockerfile # Dockerfile 경로
          push: true # Docker Hub로 푸시
          tags: ${{ env.DOCKER_IMAGE_NAME }}:latest

  # ===============================================
  # 2. CD (Deploy) Job
  # ===============================================
  deploy:
    # deploy 잡은 build 잡이 성공해야만 실행됩니다.
    needs: build
    # 'main' 브랜치에 'push' 이벤트가 발생했을 때만 실행합니다.
    # (pull_request나 develop 브랜치 푸시 때는 실행되지 않음)
    if: github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest

    steps:
      # (변경) SSH를 사용해 EC2에 접속하여 도커 컨테이너 실행
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            # 1. Docker Hub에서 최신 이미지 가져오기
            sudo docker pull ${{ env.DOCKER_IMAGE_NAME }}:latest

            # 2. (에러 무시) 기존에 실행 중이던 컨테이너 중지
            sudo docker stop anycall-server || true

            # 3. (에러 무시) 기존 컨테이너 삭제
            sudo docker rm anycall-server || true

            # 4. DB 환경변수와 함께 새 컨테이너 실행
            # (DB_USERNAME, DB_PASSWORD는 GitHub Secrets에 등록 필요)
            sudo docker run -d -p 8080:8080 --name anycall-server \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e JWT_PASSWORD=${{ secrets.JWT_PASSWORD }} \
              ${{ env.DOCKER_IMAGE_NAME }}:latest