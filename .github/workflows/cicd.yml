# =================================================================
# GitHub Actions CI/CD Workflow for Anycall Backend
# =================================================================

# 워크플로우의 이름을 지정합니다.
name: Anycall Backend CI/CD

# 워크플로우가 언제 실행될지를 정의합니다.
on:
  # 'main' 또는 'develop' 브랜치로 push 이벤트가 발생했을 때
  push:
    branches: [ "main", "develop" ]
  # 'main' 브랜치로 pull request가 생성되었을 때 (CI만 실행)
  pull_request:
    branches: [ "main" ]

jobs:
  # ===============================================
  # 1. CI (Build & Test) Job
  # ===============================================
  build:
    # 이 작업이 실행될 가상 환경을 지정합니다.
    runs-on: ubuntu-latest

    steps:
      # 1. 소스 코드 체크아웃
      - name: Checkout source code
        uses: actions/checkout@v3

      # 2. JDK 21 설치
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. gradlew 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. Gradle로 프로젝트 빌드 및 테스트
      # (build 작업은 test 작업을 자동으로 포함합니다)
      - name: Build with Gradle
        run: ./gradlew build

      # 5. (CD를 위해 추가) 빌드된 JAR 파일을 Artifact로 업로드
      # deploy 잡에서 이 파일을 다운로드하여 EC2로 전송합니다.
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: build/libs/*.jar # build/libs/ 폴더 아래의 .jar 파일을 업로드

  # ===============================================
  # 2. CD (Deploy) Job
  # ===============================================
  deploy:
    # deploy 잡은 build 잡이 성공해야만 실행됩니다.
    needs: build
    # 'main' 브랜치에 'push' 이벤트가 발생했을 때만 실행합니다.
    # (pull_request나 develop 브랜치 푸시 때는 실행되지 않음)
    if: github.ref == 'refs/heads/main'

    runs-on: ubuntu-latest

    steps:
      # 1. (준비) build 잡에서 업로드한 JAR 파일을 다운로드
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: ./build/libs # 다운로드 받을 위치

      # 2. (전송) SCP를 사용해 JAR 파일을 EC2 인스턴스로 복사
      # appleboy/scp-action 액션을 사용합니다.
      - name: SCP JAR to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "build/libs/*.jar"
          target: "/home/ec2-user/" # Amazon Linux의 기본 사용자 홈 디렉터리

      # 3. (실행) SSH를 사용해 EC2에 접속하여 서버를 재시작
      # appleboy/ssh-action 액션을 사용합니다.
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            export DB_USERNAME=${{ secrets.DB_USERNAME }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            
            JAR_NAME=$(ls /home/ec2-user/ | grep '\.jar$' | grep -v 'plain' | head -n 1)
            
            sudo kill $(sudo lsof -t -i:8080) || true 
            
            nohup java -jar /home/ec2-user/build/libs/$JAR_NAME > /home/ec2-user/app.log 2>&1 &